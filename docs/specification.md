# Anycast 仕様書

AI 専用のポッドキャストを作成・配信できるプラットフォーム。

---

## 設計ルール

本プロジェクトでは **ドメインモデル駆動** で設計を行う。

### 設計の流れ

```
1. ドメインモデル設計（本ドキュメント）
   ↓
2. API 設計（api.md）
   ↓
3. DB 設計（database.md）
```

### ルール

1. **ドメインモデルが起点**
   - 新しい機能を追加する際は、まず本ドキュメントのドメインモデルを設計する
   - DB スキーマや API は、ドメインモデルを永続化・公開するための手段として設計する

2. **ドキュメントの更新順序**
   - ドメインモデルに変更がある場合: `specification.md` → `api.md` → `database.md` の順で更新
   - DB のみの変更（インデックス追加など）: `database.md` のみ更新可

3. **整合性の維持**
   - ドメインモデルの属性と DB カラムの対応を明確にする
   - 命名規則: ドメインモデルは camelCase、DB は snake_case

4. **集約の境界を尊重**
   - 集約をまたぐ参照は ID のみで行う
   - 集約内のエンティティは集約ルートを通じてアクセスする

---

## ドメインモデル

### 全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              User 集約                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  User ─┬─ (0..1) Credential                                                 │
│        ├─ (0..N) OAuthAccount                                               │
│        └─ (0..1) Avatar [Image]                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                │ owns (0..N)
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Channel 集約                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  Channel ─┬─ (1..N) Character ── Voice [参照]                               │
│           ├─ (0..1) Artwork [Image]                                         │
│           └─ Category [参照]                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                │ contains (0..N)
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Episode 集約                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  Episode ─┬─ (0..N) ScriptLine ─┬─ (0..1) Audio [生成音声]                  │
│           │                     ├─ Speaker [Character 参照]                 │
│           │                     └─ SoundEffect [参照]                       │
│           ├─ (0..1) BGM [Audio]                                             │
│           └─ (0..1) FullAudio [Audio]                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                │ interacts
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       ユーザーインタラクション                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  Like            : User ─── Episode                                         │
│  Bookmark        : User ─── Episode                                         │
│  PlaybackHistory : User ─── Episode + 再生状態                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           マスタデータ                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  Voice        : TTS ボイス設定                                              │
│  Category     : チャンネルカテゴリ                                           │
│  SoundEffect  : 効果音 ── Audio                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           メディア                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  Audio : 音声ファイル（BGM / 生成音声 / 効果音 / エピソード全体音声）         │
│  Image : 画像ファイル（アバター / アートワーク）                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 集約とその責務

| 集約 | 集約ルート | 責務 |
|------|------------|------|
| User 集約 | User | ユーザーの識別、認証情報の管理、プロフィール管理 |
| Channel 集約 | Channel | チャンネルの管理、登場人物の定義、公開状態の制御 |
| Episode 集約 | Episode | エピソードのコンテンツ管理、台本の編集、音声生成 |

### エンティティと値オブジェクト

| 種別 | 名前 | 説明 |
|------|------|------|
| エンティティ | User, Channel, Character, Episode, ScriptLine | 一意の識別子を持ち、ライフサイクルを通じて追跡される |
| エンティティ | Like, Bookmark, PlaybackHistory | ユーザーとエピソードの関連を表す |
| エンティティ | Voice, Category, SoundEffect | システム管理のマスタデータ |
| エンティティ | Audio, Image | メディアファイル（外部ストレージへの参照） |
| 値オブジェクト | Email, Username, LineType, Gender, Volume | ドメイン固有のルール・制約を持つ値 |

### 値オブジェクト定義

値オブジェクトは **ドメイン固有のルール・バリデーション** を持つ型。同値性で比較され、不変（immutable）として扱う。

| 値オブジェクト | 型 | ルール |
|---------------|-----|--------|
| Email | String | メールアドレス形式、255文字以内、小文字正規化 |
| Username | String | 20文字以内、一意、`__` 始まり禁止、日本語可 |
| LineType | Enum | `speech` / `silence` / `sfx` |
| Gender | Enum | `male` / `female` / `neutral` |
| Volume | Decimal | 0.00〜1.00 の範囲 |
| MimeType | String | 有効な MIME タイプ形式（例: `audio/mpeg`, `image/png`） |

#### 値オブジェクトにしない例

以下は特別なルールを持たないため、単純な `String` として扱う：

- `displayName` - 文字数制限のみ（20文字以内）
- `description` - 自由入力テキスト
- `persona` - キャラクター設定（自由記述）
- `name`（Channel, Character, SoundEffect など）- 一意性は DB 制約で担保

---

## 公開状態

Channel と Episode は公開状態（`publishedAt`）を持つ。

| 状態 | 条件 | 説明 |
|------|------|------|
| 下書き | `publishedAt IS NULL` | 非公開。オーナーのみ閲覧可能 |
| 公開中 | `publishedAt <= NOW()` | 公開済み。全ユーザーが閲覧可能 |
| 予約公開 | `publishedAt > NOW()` | 指定日時に自動公開（将来対応） |

### アクセス制御

- **他ユーザー**: 公開中のチャンネル・エピソードのみ閲覧可能
- **オーナー**: 自分のチャンネル・エピソードは全て閲覧可能（下書き含む）
- **検索**: 公開中のコンテンツのみ対象

---

## User 集約

### User（ユーザー）

サービスの利用者。複数のチャンネルを所有できる。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| email | Email | ◯ | メールアドレス（一意） |
| username | Username | ◯ | ユーザー ID（20文字以内、一意、日本語可） |
| displayName | String | ◯ | 表示名（20文字以内） |
| avatar | Image | | アバター画像 |

#### username の自動生成

- 新規登録時、`displayName` から自動生成される
- スペースはアンダースコアに変換
- 重複時はランダムな番号をサフィックスとして付与
- 後からアカウント設定画面で変更可能

### Credential（パスワード認証）

メール/パスワード認証用の認証情報。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所属する User |
| passwordHash | String | ◯ | パスワードハッシュ（bcrypt） |

#### 制約

- User と 1:1 の関係（1 ユーザーにつき 1 つ）
- OAuth のみで登録したユーザーは Credential を持たない

### OAuthAccount（OAuth 認証）

OAuth プロバイダとの連携情報。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所属する User |
| provider | String | ◯ | プロバイダ名（google） |
| providerUserId | String | ◯ | プロバイダ側のユーザー ID |
| accessToken | String | | アクセストークン |
| refreshToken | String | | リフレッシュトークン |
| expiresAt | DateTime | | トークン有効期限 |

#### 制約

- User と 1:N の関係（複数プロバイダ連携可能）
- provider + providerUserId の組み合わせは一意

---

## Channel 集約

### Channel（チャンネル）

ポッドキャストのチャンネル。複数のエピソードと登場人物を管理する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | オーナー |
| name | String | ◯ | チャンネル名 |
| description | String | | チャンネルの概要・説明 |
| category | Category | ◯ | カテゴリ |
| artwork | Image | | カバー画像（ポッドキャストのアートワーク） |
| characters | Character[] | ◯ | 登場人物（1 人以上） |
| publishedAt | DateTime | | 公開日時（NULL = 下書き） |

#### 不変条件

- characters は 1 人以上必須
- 公開中のチャンネルは削除不可（先に非公開化が必要、将来的に検討）

### Character（登場人物）

チャンネルに登場するキャラクター。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| channelId | UUID | ◯ | 所属する Channel |
| name | String | ◯ | キャラクター名 |
| persona | String | | キャラクター設定（性格・話し方など） |
| voice | Voice | ◯ | TTS ボイス |

#### 制約

- **名前の一意性**: 同一 Channel 内で重複禁止
- **予約語回避**: `__` で始まる名前は禁止（システム予約語と衝突防止）
- **ボイス選択**: is_active = true の Voice のみ選択可能

---

## Episode 集約

### Episode（エピソード）

チャンネル内の各エピソード。台本と BGM を持つ。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| channelId | UUID | ◯ | 所属する Channel |
| title | String | ◯ | エピソードタイトル |
| description | String | | エピソードの説明 |
| script | ScriptLine[] | | 台本（順序付きの ScriptLine 配列） |
| bgm | Audio | | BGM 音声ファイル |
| fullAudio | Audio | | 結合済み音声（全 ScriptLine + BGM） |
| publishedAt | DateTime | | 公開日時（NULL = 下書き） |

#### 入力形式

エピソード作成時の入力は以下のいずれか：

| 入力形式 | 説明 |
|----------|------|
| テキスト入力 | テーマやシナリオを入力して LLM が台本生成。URL が含まれていれば RAG で内容を取得 |
| ファイル入力 | 台本フォーマットのファイルをインポート |

#### BGM

- エピソードに 1 つの BGM を設定可能
- 音声ファイル形式: mp3
- エピソード全体の音声出力時に BGM とミックス

### ScriptLine（台本行）

台本の各行（イベント）。lineType によって必須属性が異なる。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子（= lineId）。並び替え・編集後も追跡可能 |
| episodeId | UUID | ◯ | 所属する Episode |
| lineOrder | Int | ◯ | 行の順序（0 始まり） |
| lineType | LineType | ◯ | 行の種類（`speech` / `silence` / `sfx`） |
| speaker | Character | △ | 話者（speech 時のみ必須） |
| text | String | △ | セリフ（speech 時のみ必須、空禁止） |
| emotion | String | | 感情・喋り方（speech 時のみ）例: 嬉しい、悲しい、笑いながら |
| durationMs | Int | △ | 無音時間 ms（silence 時のみ必須、0〜10000） |
| sfx | SoundEffect | △ | 効果音（sfx 時のみ必須） |
| volume | Decimal | | 音量 0.0〜1.0（sfx 時のみ、デフォルト 1.0） |
| audio | Audio | | 生成済み音声 |

#### lineType 別の必須属性

| lineType | 必須属性 | 説明 |
|----------|----------|------|
| speech | speaker, text | キャラクターのセリフ |
| silence | durationMs | 無音区間 |
| sfx | sfx | 効果音 |

#### emotion の反映

emotion は TTS 生成時に text の先頭にカッコで付けて表現する：

```
[笑いながら] こんにちは。
[悲しそうに] さようなら...
```

#### 制約

- speaker は同じ Channel に属する Character のみ指定可能
- lineOrder は Episode 内で一意

### 台本の編集操作

- 行の追加
- 行の削除
- 行の並び替え
- 行の更新

---

## 台本テキストフォーマット

台本の取り込み・出力時に使用するテキスト形式。

### 基本ルール

- 区切りは半角 `:` のみ
- 1 行 = 1 イベント
- 複数行のセリフは同キャラを連続して記述

### 構文

```
# speech 行
<speakerName>: <text>

# silence 行（予約語）
__SILENCE__: <ms>

# sfx 行（予約語）
__SFX__: <sfxId>
```

### 例

```
太郎: こんにちは
花子: やあ、元気？
__SILENCE__: 800
__SFX__: chime
太郎: うん、元気だよ
花子: それは良かった
```

### 予約語

| 予約語 | 説明 |
|--------|------|
| `__SILENCE__` | 無音時間（ms） |
| `__SFX__` | 効果音（sfxId を指定） |

---

## 取り込みバリデーション

### 入力

- 台本テキスト
- allowedSpeakers（Channel の登場人物名リスト）
- availableSfx（利用可能な効果音 ID リスト）

### 出力

- 成功: ScriptLine 配列
- 失敗: エラー（行番号 + 理由）

### バリデーションルール

| 条件 | 結果 |
|------|------|
| `:` が無い行 | エラー |
| lhs / rhs を trim 後に処理 | - |
| lhs == `__SILENCE__` かつ rhs が 0〜10000 の整数 | silence 行として OK |
| lhs == `__SILENCE__` かつ rhs が不正 | エラー |
| lhs == `__SFX__` かつ rhs が availableSfx に存在 | sfx 行として OK |
| lhs == `__SFX__` かつ rhs が不正 | エラー |
| lhs が allowedSpeakers に存在しない | エラー |
| rhs（セリフ）が空 | エラー |

---

## 音声生成

### 行単位生成

| 対象 | 処理 |
|------|------|
| speech 行 | TTS で mp3 生成（emotion 反映） |
| silence 行 | TTS しない。再生時に指定 ms 待機 |
| sfx 行 | 事前登録された効果音ファイルを使用 |

### エピソード全体出力

- すべての行の音声を順番に結合
- silence 行は指定時間の無音を挿入
- sfx 行は効果音を挿入
- BGM が設定されている場合はミックス
- 出力形式: mp3

### キャッシュ

- lineId 単位で音声をキャッシュ
- 行の内容が変更されない限りキャッシュを再利用

---

## ユーザーインタラクション

ユーザーとエピソードの関係を表すエンティティ群。

### Like（いいね）

ユーザーがエピソードに「いいね」したことを記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | ユーザー |
| episodeId | UUID | ◯ | エピソード |
| createdAt | DateTime | ◯ | いいね登録日時 |

#### 制約

- user + episode の組み合わせは一意（同じエピソードに複数回いいねできない）

### Bookmark（後で見る）

ユーザーがエピソードを「後で見る」に追加したことを記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | ユーザー |
| episodeId | UUID | ◯ | エピソード |
| createdAt | DateTime | ◯ | ブックマーク登録日時 |

#### 制約

- user + episode の組み合わせは一意（同じエピソードを複数回ブックマークできない）

### PlaybackHistory（再生履歴）

ユーザーのエピソード再生履歴と再生位置を記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | ユーザー |
| episodeId | UUID | ◯ | エピソード |
| progressMs | Int | ◯ | 再生位置（ミリ秒）、デフォルト 0 |
| completed | Boolean | ◯ | 再生完了フラグ、デフォルト false |
| playedAt | DateTime | ◯ | 最終再生日時 |

#### 制約

- user + episode の組み合わせは一意（履歴は上書き更新される）
- progressMs は 0 以上

#### ユースケース

- **レジューム再生**: 途中から再生を再開
- **視聴完了トラッキング**: 最後まで聴いたエピソードの管理
- **視聴履歴表示**: 最近聴いたエピソードの一覧

---

## マスタデータ

システムが管理するマスタデータ。ユーザーは参照のみ可能。

### Voice（ボイス）

TTS ボイスの設定情報。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| provider | String | ◯ | TTS プロバイダ（google / azure / etc） |
| providerVoiceId | String | ◯ | プロバイダ側の音声 ID（例: ja-JP-Wavenet-C） |
| name | String | ◯ | 表示名 |
| gender | Gender | ◯ | 性別（male / female / neutral） |
| isActive | Boolean | ◯ | 有効フラグ |

#### 制約

- provider + providerVoiceId の組み合わせは一意
- isActive = false の Voice は新規キャラクター作成時に選択不可
- 既存キャラクターは isActive = false の Voice を継続利用可能
- 物理削除は行わず、isActive フラグで無効化

#### TTS プロバイダ

| プロバイダ | 説明 |
|------------|------|
| google | Google Cloud Text-to-Speech |
| azure | Azure Cognitive Services（将来対応） |

### Category（カテゴリ）

ポッドキャストのカテゴリ。Apple Podcasts 準拠。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| slug | String | ◯ | URL フレンドリーな識別子（例: technology） |
| name | String | ◯ | 表示名（例: テクノロジー） |
| sortOrder | Int | ◯ | 表示順 |

#### 制約

- slug は一意

### SoundEffect（効果音）

台本で使用できる効果音。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| name | String | ◯ | 効果音の識別名（例: chime, applause） |
| description | String | | 効果音の説明 |
| audio | Audio | ◯ | 音声ファイル |

#### 制約

- name は一意
- 台本テキストの `__SFX__: <name>` で参照
- 使用中の効果音は削除不可（RESTRICT）

---

## メディア

外部ストレージに保存されるメディアファイル。

### Audio（音声ファイル）

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| mimeType | String | ◯ | MIME タイプ（audio/mpeg など） |
| url | String | ◯ | ストレージ URL（GCS） |
| filename | String | ◯ | 元ファイル名 |
| fileSize | Int | ◯ | ファイルサイズ（バイト） |
| durationMs | Int | ◯ | 再生時間（ミリ秒） |

#### 用途

| 用途 | 説明 |
|------|------|
| BGM | エピソードの背景音楽 |
| 生成音声 | ScriptLine から生成された音声 |
| 効果音 | SoundEffect の音源 |
| エピソード全体音声 | 全行 + BGM を結合した音声 |

### Image（画像ファイル）

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| mimeType | String | ◯ | MIME タイプ（image/png, image/jpeg など） |
| url | String | ◯ | ストレージ URL（GCS） |
| filename | String | ◯ | 元ファイル名 |
| fileSize | Int | ◯ | ファイルサイズ（バイト） |

#### 用途

| 用途 | 説明 |
|------|------|
| アバター | ユーザーのプロフィール画像 |
| アートワーク | チャンネルのカバー画像 |

### メディア管理

- url には GCS（Google Cloud Storage）の URL を保存
- 同一ファイルを複数箇所から参照可能（BGM の使い回しなど）
- 参照元が削除されてもメディアファイルは残る（SET NULL）
- 未使用ファイルのクリーンアップはバッチ処理で実施
