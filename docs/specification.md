# Anycast 仕様書

AI 専用のポッドキャストを作成・配信できるプラットフォーム。

## ドメインモデル概要

```
User (1) ── (0..N) Channel (1) ─┬─ (1..N) Character
                                ├─ (0..1) Artwork
                                └─ (0..N) Episode ─┬─ (1) Script ── (0..N) ScriptLine
                                                   └─ (0..1) BGM
```

---

## User（ユーザー）

サービスの利用者。複数のチャンネルを所有できる。

| 項目 | 必須 | 説明 |
|------|:----:|------|
| id | ◯ | ユーザー ID（Firebase Authentication の UID） |

---

## Channel（チャンネル）

ポッドキャストのチャンネル。複数のエピソードと登場人物を管理する。

| 項目 | 必須 | 説明 |
|------|:----:|------|
| name | ◯ | チャンネル名 |
| description | | チャンネルの概要・説明 |
| artwork | | カバー画像（ポッドキャストのアートワーク） |
| characters | ◯ | 登場人物（1 人以上） |

---

## Character（登場人物）

チャンネルに登場するキャラクター。

| 項目 | 必須 | 説明 |
|------|:----:|------|
| name | ◯ | キャラクター名 |
| persona | | キャラクター設定（性格・話し方など） |
| voiceType | ◯ | TTS のボイス ID |

### 制約

- **名前の一意性**: 同一 Channel 内で重複禁止
- **予約語回避**: `__` で始まる名前は禁止（システム予約語と衝突防止）

### TTS プロバイダ

| プロバイダ | 説明 |
|------------|------|
| Google TTS | Google Cloud Text-to-Speech |
| その他 | 拡張可能な設計（プロバイダ追加時に voiceType の形式を定義） |

---

## Episode（エピソード）

チャンネル内の各エピソード。台本と BGM を持つ。

| 項目 | 必須 | 説明 |
|------|:----:|------|
| title | ◯ | エピソードタイトル |
| script | ◯ | 台本（ScriptLine の配列） |
| bgm | | BGM 音声ファイル |

### 入力形式

エピソード作成時の入力は以下のいずれか：

| 入力形式 | 説明 |
|----------|------|
| テキスト入力 | テーマやシナリオを入力して LLM が台本生成。URL が含まれていれば RAG で内容を取得 |
| ファイル入力 | 台本フォーマットのファイルをインポート |

### BGM

- エピソードに 1 つの BGM を設定可能
- 音声ファイル形式: mp3
- エピソード全体の音声出力時に BGM とミックス

---

## Script / ScriptLine

Script は順序付きの ScriptLine 配列。

### 共通フィールド

| フィールド | 説明 |
|------------|------|
| lineId | 行の不変 ID（UUID）。並び替え・編集後も追跡可能 |
| type | 行の種類（`speech` / `silence` / `sfx`） |

### ScriptLine: speech（会話）

| フィールド | 必須 | 説明 |
|------------|:----:|------|
| speakerName | ◯ | Channel に登録された Character 名（完全一致必須） |
| text | ◯ | セリフ（空禁止、1 行完結） |
| emotion | | 感情・喋り方。例: 「嬉しい」「悲しい」「笑いながら」 |

#### emotion の反映

emotion は text の先頭にカッコで付けて表現する（TTS の仕様）：

```
[笑いながら] こんにちは。
[悲しそうに] さようなら...
```

### ScriptLine: silence（無音）

| フィールド | 必須 | 説明 |
|------------|:----:|------|
| durationMs | ◯ | 無音時間（0〜10000 ms） |

### ScriptLine: sfx（効果音）

| フィールド | 必須 | 説明 |
|------------|:----:|------|
| sfxId | ◯ | 効果音の識別子 |
| volume | | 音量（0.0〜1.0、デフォルト 1.0） |

### 台本の編集操作

- 行の追加
- 行の削除
- 行の並び替え
- 行の更新

---

## 台本テキストフォーマット

台本の取り込み・出力時に使用するテキスト形式。

### 基本ルール

- 区切りは半角 `:` のみ
- 1 行 = 1 イベント
- 複数行のセリフは同キャラを連続して記述

### 構文

```
# speech 行
<speakerName>: <text>

# silence 行（予約語）
__SILENCE__: <ms>

# sfx 行（予約語）
__SFX__: <sfxId>
```

### 例

```
太郎: こんにちは
花子: やあ、元気？
__SILENCE__: 800
__SFX__: chime
太郎: うん、元気だよ
花子: それは良かった
```

### 予約語

| 予約語 | 説明 |
|--------|------|
| `__SILENCE__` | 無音時間（ms） |
| `__SFX__` | 効果音（sfxId を指定） |

---

## 取り込みバリデーション

### 入力

- 台本テキスト
- allowedSpeakers（Channel の登場人物名リスト）
- availableSfx（利用可能な効果音 ID リスト）

### 出力

- 成功: ScriptLine 配列
- 失敗: エラー（行番号 + 理由）

### バリデーションルール

| 条件 | 結果 |
|------|------|
| `:` が無い行 | エラー |
| lhs / rhs を trim 後に処理 | - |
| lhs == `__SILENCE__` かつ rhs が 0〜10000 の整数 | silence 行として OK |
| lhs == `__SILENCE__` かつ rhs が不正 | エラー |
| lhs == `__SFX__` かつ rhs が availableSfx に存在 | sfx 行として OK |
| lhs == `__SFX__` かつ rhs が不正 | エラー |
| lhs が allowedSpeakers に存在しない | エラー |
| rhs（セリフ）が空 | エラー |

---

## 音声生成

### 行単位生成

| 対象 | 処理 |
|------|------|
| speech 行 | TTS で mp3 生成（emotion 反映） |
| silence 行 | TTS しない。再生時に指定 ms 待機 |
| sfx 行 | 事前登録された効果音ファイルを使用 |

### エピソード全体出力

- すべての行の音声を順番に結合
- silence 行は指定時間の無音を挿入
- sfx 行は効果音を挿入
- BGM が設定されている場合はミックス
- 出力形式: mp3

### キャッシュ

- lineId 単位で音声をキャッシュ
- 行の内容が変更されない限りキャッシュを再利用
