# 台本生成 API 詳細設計

## 概要

エピソードに対して AI を使って台本（ScriptLine の配列）を自動生成する API。

| 項目 | 値 |
|------|-----|
| メソッド | POST |
| パス | `/api/v1/channels/:channelId/episodes/:episodeId/script/generate` |
| 認証 | 必須（Bearer Token） |
| 権限 | Owner（チャンネルのオーナーのみ） |

---

## 処理フロー

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Handler                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ 1. 認証ユーザー ID 取得（middleware から）                                   │
│ 2. パスパラメータ取得・バリデーション（channelId, episodeId）                │
│ 3. リクエストボディ取得・バリデーション                                      │
│ 4. Service 呼び出し                                                         │
│ 5. レスポンス返却                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Service                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│ 1. UUID パース                                                              │
│ 2. チャンネル取得・オーナーチェック                                          │
│ 3. エピソード取得・チャンネル一致チェック                                    │
│ 4. 既存の台本行を削除（再生成のため）                                        │
│ 5. LLM 用プロンプト構築                                                     │
│    - システムプロンプト（サーバー側固定、ユーザー閲覧/変更不可）             │
│    - user.userPrompt（ユーザー基本方針）                                   │
│    - channel.userPrompt（チャンネル全体方針）                              │
│    - channel.characters（登場人物情報）                                     │
│    - prompt（ユーザー入力）                                                 │
│ 6. LLM API 呼び出し（台本生成）                                             │
│ 7. LLM レスポンスをパース（ScriptLine 配列に変換）                          │
│ 8. episode.userPrompt に prompt を保存                                    │
│ 9. 台本行を DB に保存                                                       │
│ 10. レスポンス DTO に変換して返却                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## LLM プロンプト設計

### プロンプト構成

```
┌───────────────────────────────────────────────────────┐
│ System Prompt（サーバー側固定）                       │
│ - ポッドキャスト台本生成の基本ルール                  │
│ - 出力形式の指定                                      │
│ - lineType は speech のみ                            │
└───────────────────────────────────────────────────────┘
                        │
                        ▼
┌───────────────────────────────────────────────────────┐
│ User Prompt                                           │
│ ├─ user.userPrompt（ユーザー基本方針）                │
│ ├─ channel.name（チャンネル名）                       │
│ ├─ channel.description（チャンネル説明）              │
│ ├─ channel.category（チャンネルカテゴリー）           │
│ ├─ channel.userPrompt（チャンネル全体方針）           │
│ ├─ channel.characters（登場人物リスト）               │
│ ├─ episode.title（エピソードタイトル）                │
│ ├─ episode.description（エピソード説明）              │
│ ├─ durationMinutes（エピソードの長さ）                │
│ └─ prompt（ユーザー入力テーマ）                       │
└───────────────────────────────────────────────────────┘
```

### 入力情報

| 情報 | 取得元 | 説明 |
|------|--------|------|
| システムプロンプト | サーバー側固定 | ポッドキャスト台本生成の基本ルール（ユーザー閲覧/変更不可） |
| userPrompt | user.userPrompt | ユーザーの基本方針（全チャンネル・エピソードに適用） |
| name | channel.name | チャンネル名 |
| description | channel.description | チャンネルの説明 |
| category | channel.category | チャンネルのカテゴリー（コメディ、教育、ニュースなど） |
| userPrompt | channel.userPrompt | チャンネル全体の方針（「明るく楽しい雰囲気で」など） |
| characters | channel.characters | 登場人物リスト（名前、性別、ペルソナ） |
| title | episode.title | エピソードのタイトル |
| description | episode.description | エピソードの説明 |
| prompt | リクエスト | ユーザーが入力したテーマ/シナリオ |
| durationMinutes | リクエスト | エピソードの長さ（分）。3〜30分、デフォルト10分 |

### プロンプト適用順序

台本生成時、プロンプトは以下の順序で結合（追記）される：

1. **user.userPrompt** - ユーザーの基本方針
2. **channel.userPrompt** - チャンネル固有の方針
3. **episode.userPrompt**（リクエストの prompt）- エピソード固有の設定

### 出力形式（LLM に期待する形式）

```
話者名: [感情] セリフ
```

**例:**

```
太郎: こんにちは！今日は天気について話そうか
花子: [嬉しそうに] いいね！今日は晴れでポカポカ陽気だよ
太郎: [驚いて] そうなんだ！じゃあ散歩にでも行こうかな
花子: それはいい考えだね
```

**フォーマット仕様:**

| 要素 | 必須 | 説明 |
|------|:----:|------|
| 話者名 | ◯ | 登場人物リストの名前（コロンの前） |
| 感情 | | `[感情]` 形式で指定（省略可） |
| セリフ | ◯ | 話者が話す内容 |

**備考:**
- このフォーマットは「台本テキスト取り込み API」と共通
- AI 生成台本も取り込み台本も、同じパーサーで ScriptLine に変換する

### システムプロンプト

```
あなたはポッドキャスト台本を作成する専門家です。

## 基本ルール
- 自然な会話のテンポを意識する
- 登場人物それぞれの個性（ペルソナ）を反映したセリフにする
- 長すぎるセリフは避け、1つのセリフは50〜100文字程度を目安にする
- 聞き手が理解しやすいよう、適度に相槌や確認を入れる
- 人間らしい自然な会話感を出すために、適度にフィラー（「えーと」「あのー」「まあ」「なんか」「うーん」など）を入れる
- 指定されたエピソードの長さ（分）に合わせた台本を作成する
  - 目安として、1分あたり約300文字程度のセリフ量になるよう調整する
  - 10分のエピソードなら約3000文字、30分なら約9000文字が目安

## 出力形式
以下のテキスト形式で出力してください：

話者名: [感情] セリフ

- 感情は省略可能。指定する場合は [感情] の形式でセリフの前に記載
- 1行につき1つのセリフ
- 空行は入れない

例：
太郎: こんにちは！
花子: [嬉しそうに] やあ、元気？
太郎: 元気だよ！

## 制約
- 話者名は与えられた登場人物リストの名前のみ使用可能
- 台本テキスト以外の説明文やコメントは出力しない
```

### ユーザープロンプト構築例

```
## ユーザー設定
{user.userPrompt}

## チャンネル情報
チャンネル名: {channel.name}
説明: {channel.description}
カテゴリー: {channel.category}

## チャンネル設定
{channel.userPrompt}

## 登場人物
- 太郎（male）: 明るく元気な性格。語尾に「だよね」をつけがち。
- 花子（female）: 落ち着いた知的な性格。論理的に話す。

## エピソード情報
タイトル: {episode.title}
説明: {episode.description}

## エピソードの長さ
{durationMinutes}分

## 今回のテーマ
{prompt}
```

※ `user.userPrompt` と `channel.userPrompt` が空の場合、それぞれのセクションは省略される

---

## エラーハンドリング

| シナリオ | 対応 |
|----------|------|
| LLM API タイムアウト | リトライ（最大 3 回）後、GENERATION_FAILED |
| LLM レスポンスパースエラー | GENERATION_FAILED（詳細ログ出力） |
| 存在しない話者名が返された | 無視するか、最初のキャラクターで代替 |

---

## 既存台本の扱い

- 再生成時は既存の台本行を**全削除**してから新規作成
- 音声生成済みの場合も削除される（再度音声生成が必要）
- 確認ダイアログは**フロントエンド**で表示する

---

## トランザクション

以下の操作は 1 トランザクションで行う：

1. 既存台本行の削除
2. episode.userPrompt の更新
3. 新規台本行の一括作成

---

## 技術選定

### LLM プロバイダ

- **初期実装**: OpenAI（GPT-4o）
- **将来的な拡張**:
  - モデル選択機能の追加
  - 異なるモデルでの相互レビュー機能

### RAG（参考情報取得）

- **初期実装**: 実装しない
- **将来的な拡張**:
  - prompt 内の URL からコンテンツを取得
  - 取得したコンテンツを要約して LLM に渡す

---

## 将来的な拡張

| 機能 | 説明 | 優先度 |
|------|------|:------:|
| silence 対応 | lineType に silence を追加 | 中 |
| RAG 対応 | URL からコンテンツ取得・要約 | 中 |
| モデル選択 | 複数の LLM プロバイダから選択可能に | 低 |
| 相互レビュー | 異なるモデルで生成結果をレビュー | 低 |
