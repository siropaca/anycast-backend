# ADR-020: グレースフルシャットダウンの実装

## ステータス

Accepted

## コンテキスト

現在、HTTP サーバーは `ListenAndServe()` をそのまま呼び出しており、SIGINT / SIGTERM を受信するとプロセスが即座に終了する。これにより以下の問題が発生する：

- 処理中のリクエスト（LLM 台本生成、音声合成など長時間処理を含む）が中断される
- DB コネクションプール、GCS クライアント、Cloud Tasks クライアントなどの外部リソースが適切にクローズされない
- WebSocket 接続が CloseMessage を送信せずに切断される
- Cloud Run のデプロイ時にインフライトリクエストが失われる可能性がある

Cloud Run はデプロイ時に SIGTERM を送信し、デフォルト 10 秒後に SIGKILL する。この猶予時間内にリクエストを完了しリソースを解放する仕組みが必要。

## 決定

`os/signal` によるシグナルハンドリングと `http.Server.Shutdown()` を使い、グレースフルシャットダウンを実装する。

## 選択肢

### 選択肢 1: 標準ライブラリのみで実装

`os/signal.NotifyContext` で SIGINT / SIGTERM を捕捉し、`http.Server.Shutdown(ctx)` でインフライトリクエストの完了を待ってからリソースをクローズする。

- メリット: 外部依存なし、Go の標準パターンに従う
- デメリット: 特になし

### 選択肢 2: サードパーティライブラリ（graceful, endless 等）を使用

サードパーティのシャットダウンライブラリを導入する。

- メリット: 設定が簡素になる場合がある
- デメリット: 外部依存が増える、Go 標準で十分対応可能

## 理由

Go 1.16 以降の `signal.NotifyContext` と `http.Server.Shutdown` で十分にグレースフルシャットダウンを実現できる。本プロジェクトは外部依存を最小限に抑える方針のため、標準ライブラリのみで実装する。

## 結果

- `main.go` でシグナルを捕捉し、`Shutdown()` → リソースクローズの順で安全に停止する
- DI コンテナに `Close()` メソッドを追加し、外部クライアントのクリーンアップを一元管理する
- シャットダウンタイムアウトは 30 秒とし、Cloud Run の猶予時間内に収まるようにする
- WebSocket Hub にコンテキストベースの停止機構を追加する
