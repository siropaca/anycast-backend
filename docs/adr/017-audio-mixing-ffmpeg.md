# ADR-017: 音声ミキシングに FFmpeg を使用

## ステータス

Accepted

## コンテキスト

台本から生成した音声（ナレーション）とエピソードに設定された BGM をミックスして、最終的な音声ファイルを生成する機能が必要になった。

現在、音声生成には Google Cloud TTS (Gemini 2.5 Pro TTS) を使用しており、生成された音声ファイルは MP3 形式で GCS に保存されている。  
BGM も同様に MP3 形式で管理されている。

音声ミキシングを実現するために、適切なツール・ライブラリの選定が必要。

## 決定

音声ミキシングには **FFmpeg** を使用する。Go から `os/exec` パッケージを使って FFmpeg コマンドを実行する方式を採用する。

## 選択肢

### 選択肢 1: FFmpeg（コマンドライン実行）

- メリット
  - 音声・動画処理のデファクトスタンダードで、機能が非常に豊富
  - 音質が高く、様々なフォーマットに対応
  - ドキュメントやコミュニティが充実しており、トラブルシューティングが容易
  - 音量調整、フェードイン・フェードアウト、ループ再生など高度な処理が可能
- デメリット
  - システムに FFmpeg のインストールが必要（Docker イメージへの追加が必要）
  - 外部プロセス呼び出しによるオーバーヘッド

### 選択肢 2: Go 純正ライブラリ（go-audio/audio など）

- メリット
  - 外部依存がなく、デプロイが容易
  - Go のコード内で完結するため、デバッグしやすい
- デメリット
  - MP3 の直接処理は限定的で、WAV への変換が必要になることが多い
  - 機能が限られており、高度な音声処理には不向き
  - コミュニティが小さく、ドキュメントが少ない

### 選択肢 3: クラウドサービス（AWS MediaConvert, Cloudinary など）

- メリット
  - インフラ管理が不要
  - スケーラビリティが高い
- デメリット
  - 追加のランニングコストが発生
  - 外部サービスへの依存によるレイテンシ増加
  - サービス障害時の影響を受ける

## 理由

1. **機能の豊富さ**: FFmpeg は音声ミキシングに必要な機能（音量調整、ミキシング、フェード処理など）をすべて備えている
2. **品質**: 長年の実績があり、音質面で信頼性が高い
3. **コスト**: OSS であり、追加のランニングコストが発生しない
4. **実績**: 多くのプロダクションシステムで採用されており、ノウハウが豊富
5. **拡張性**: 将来的に動画処理が必要になった場合にも対応可能

## 結果

この決定により、以下の作業が必要になる：

1. Docker イメージに FFmpeg をインストールする（`apt-get install ffmpeg` または Alpine の場合 `apk add ffmpeg`）
2. `internal/pkg/audio` または `internal/infrastructure` 配下に FFmpeg ラッパーを実装する
3. 音声生成フローに BGM ミキシング処理を追加する
4. ミキシング時の音量バランス（BGM の音量を下げるなど）を設定可能にする
