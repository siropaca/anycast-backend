# ADR-014: 孤児メディアファイル削除 API

## ステータス

Accepted

## コンテキスト

`audios` および `images` テーブルには、アップロードされたメディアファイルの情報が保存される。  
これらのファイルは、エピソードやチャンネルなどの親リソースから参照されるが、運用を続けると参照されなくなった「孤児レコード」が蓄積される可能性がある。

孤児レコードが発生するケース:
- 親リソース削除時に外部キーが `ON DELETE SET NULL` で処理される
- アップロード後に保存処理が失敗する
- 一時的にアップロードしたが使用されなかった

これらの孤児レコードは GCS のストレージコストを圧迫するため、定期的なクリーンアップが必要。

## 決定

管理者用 API エンドポイントを追加し、孤児メディアファイルを検出・削除する機能を提供する。

```
POST /admin/cleanup/orphaned-media
```

## 選択肢

### 選択肢 1: 管理者 API エンドポイント

- メリット
  - シンプルな実装
  - 外部サービス（Cloud Scheduler など）から HTTP で定期実行可能
  - dry-run モードで事前確認ができる
- デメリット
  - 処理が長時間かかると HTTP タイムアウトの可能性

### 選択肢 2: 非同期ジョブキュー（Cloud Tasks / Pub/Sub）

- メリット
  - タイムアウトの心配がない
  - 大量データでも安心
- デメリット
  - 実装が複雑
  - 追加のインフラが必要

### 選択肢 3: Cloud Run Jobs を API からトリガー

- メリット
  - ジョブの実行履歴が Cloud Console で確認可能
  - タイムアウトの心配がない
- デメリット
  - Cloud Run Jobs のセットアップが必要
  - 実装が複雑

## 理由

現時点ではデータ量が限定的であり、シンプルな実装を優先する。
データ量が増加してタイムアウトが問題になった場合は、選択肢 2 または 3 への移行を検討する。

## 結果

### 対象となる孤児レコード

**audios（以下すべてに該当しないもの）:**
- `episodes.bgm_id`
- `episodes.full_audio_id`

**images（以下すべてに該当しないもの）:**
- `users.avatar_id`
- `channels.artwork_id`
- `episodes.artwork_id`

### 仕様

| 項目 | 内容 |
|------|------|
| 認証 | 管理者専用（Admin 権限） |
| dry-run | クエリパラメータ `?dry_run=true` で削除対象の確認のみ |
| 対象条件 | `created_at` から 1 時間以上経過したレコードのみ |
| 削除順序 | GCS ファイル削除 → DB レコード削除（外部 URL の画像は GCS 削除をスキップ） |

### 今後の拡張

- Cloud Scheduler からの定期実行
- データ量増加時は非同期処理への移行を検討
