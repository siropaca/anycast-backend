# Anycast 仕様書

AIポッドキャスト作成・配信プラットフォーム。

---

## 設計ルール

本プロジェクトでは **ドメインモデル駆動** で設計を行う。

### 設計の流れ

```
1. ドメインモデル設計（本ドキュメント）
   ↓
2. API 設計（api.md）
   ↓
3. DB 設計（database.md）
```

### ルール

1. **ドメインモデルが起点**
   - 新しい機能を追加する際は、まず本ドキュメントのドメインモデルを設計する
   - DB スキーマや API は、ドメインモデルを永続化・公開するための手段として設計する

2. **ドキュメントの更新順序**
   - ドメインモデルに変更がある場合: `domain-model.md` → `api.md` → `database.md` の順で更新
   - DB のみの変更（インデックス追加など）: `database.md` のみ更新可

3. **整合性の維持**
   - ドメインモデルの属性と DB カラムの対応を明確にする
   - 命名規則: ドメインモデルは camelCase、DB は snake_case

4. **集約の境界を尊重**
   - 集約をまたぐ参照は ID のみで行う
   - 集約内のエンティティは集約ルートを通じてアクセスする

---

## ドメインモデル

### 全体図

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              User 集約                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  User ─┬─ (0..1) Credential                                                 │
│        ├─ (0..N) OAuthAccount                                               │
│        ├─ (0..N) RefreshToken                                               │
│        ├─ (0..N) ApiKey                                                     │
│        ├─ (0..1) Avatar [Image]                                             │
│        ├─ (0..1) HeaderImage [Image]                                        │
│        └─ (0..N) Character ─┬─ Voice [参照]                                 │
│                             └─ (0..1) Avatar [Image]                        │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                │ owns (0..N)
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Channel 集約                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  Channel ─┬─ (1..N) Character [参照、User 所有]                             │
│           ├─ (0..1) Artwork [Image]                                         │
│           └─ Category [参照]                                                │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                │ contains (0..N)
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Episode 集約                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  Episode ─┬─ (0..N) ScriptLine ── Speaker [Character 参照]                  │
│           ├─ (0..1) BGM [Audio]                                             │
│           ├─ (0..1) VoiceAudio [Audio]                                      │
│           └─ (0..1) FullAudio [Audio]                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                │
                │ interacts
                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            Playlist 集約                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  Playlist ─── (0..N) PlaylistItem ─── Episode [参照]                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                       ユーザーインタラクション                                │
├─────────────────────────────────────────────────────────────────────────────┤
│  Reaction        : User ─── Episode + リアクションタイプ（like/bad）          │
│  PlaybackHistory : User ─── Episode + 再生状態                              │
│  Follow          : User ─── User（自分以外のユーザーのみ）                  │
│  Comment         : User ─── Episode + コメント内容                          │
│  FavoriteVoice   : User ─── Voice（ボイスのお気に入り）                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           サポート                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  Contact         : お問い合わせ（認証任意、カテゴリ付き）                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           マスタデータ                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  Voice        : TTS ボイス設定                                              │
│  Category     : チャンネルカテゴリ                                           │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           メディア                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  Audio : 音声ファイル（BGM / 効果音 / エピソード全体音声）                    │
│  Image : 画像ファイル（アバター / アートワーク）                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 集約とその責務

| 集約 | 集約ルート | 責務 |
|------|------------|------|
| User 集約 | User | ユーザーの識別、認証情報の管理、トークン管理、プロフィール管理、キャラクター管理 |
| Channel 集約 | Channel | チャンネルの管理、キャラクターの紐づけ、公開状態の制御 |
| Episode 集約 | Episode | エピソードのコンテンツ管理、台本の編集、音声生成 |
| Playlist 集約 | Playlist | 再生リストの管理、エピソードの順序管理 |

### エンティティと値オブジェクト

| タイプ | 名前 | 説明 |
|------|------|------|
| エンティティ | User, Channel, Character, Episode, ScriptLine | 一意の識別子を持ち、ライフサイクルを通じて追跡される |
| エンティティ | Playlist, PlaylistItem | ユーザー所有の再生リストとアイテム |
| エンティティ | Reaction, PlaybackHistory, Follow, Comment, FavoriteVoice | ユーザーとエピソード/ユーザー/ボイスの関連を表す |
| エンティティ | Voice, Category | システム管理のマスタデータ |
| エンティティ | Audio, Image | メディアファイル（外部ストレージへの参照） |
| 値オブジェクト | Email, Username, OAuthProvider, Gender, MimeType | ドメイン固有のルール・制約を持つ値 |

### 値オブジェクト定義

値オブジェクトは **ドメイン固有のルール・バリデーション** を持つ型。同値性で比較され、不変（immutable）として扱う。

| 値オブジェクト | 型 | ルール |
|---------------|-----|--------|
| Email | String | メールアドレス形式、255文字以内、小文字正規化 |
| Username | String | 20文字以内、一意、`__` 始まり禁止、日本語可 |
| OAuthProvider | Enum | `google`（将来的に `apple`, `github` など追加可能） |
| Gender | Enum | `male` / `female` / `neutral` |
| MimeType | String | 有効な MIME タイプ形式（例: `audio/mpeg`, `image/png`） |
| Role | Enum | `user` / `admin` |
| ReactionType | Enum | `like` / `bad` |
| ContactCategory | Enum | `general` / `bug_report` / `feature_request` / `other` |

#### 値オブジェクトにしない例

以下は特別なルールを持たないため、単純な `String` として扱う：

- `displayName` - 文字数制限のみ（20文字以内）
- `bio` - 文字数制限のみ（200文字以内）
- `description` - 自由入力テキスト
- `persona` - キャラクター設定（自由記述）
- `name`（Channel, Character など）- 一意性は DB 制約で担保

---

## 公開状態

Channel と Episode は公開状態（`publishedAt`）を持つ。

| 状態 | 条件 | 説明 |
|------|------|------|
| 下書き | `publishedAt IS NULL` | 非公開。オーナーのみ閲覧可能 |
| 公開中 | `publishedAt <= NOW()` | 公開済み。全ユーザーが閲覧可能 |
| 予約公開 | `publishedAt > NOW()` | 指定日時に自動公開（将来対応） |

### アクセス制御

- **他ユーザー**: 公開中のチャンネル・エピソードのみ閲覧可能
- **オーナー**: 自分のチャンネル・エピソードは全て閲覧可能（下書き含む）
- **管理者**: 全ユーザーのチャンネル・エピソードを閲覧・編集・削除可能
- **検索**: 公開中のコンテンツのみ対象

### ロールと権限

| ロール | 権限 |
|--------|------|
| user | 自分のコンテンツのみ管理可能 |
| admin | マスタデータ（Voice, Category）の CRUD、全ユーザーのコンテンツ管理 |

---

## User 集約

### User（ユーザー）

サービスの利用者。複数のチャンネルとキャラクターを所有できる。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| email | Email | ◯ | メールアドレス（一意） |
| username | Username | ◯ | ユーザー ID（20文字以内、一意、日本語可） |
| displayName | String | ◯ | 表示名（20文字以内） |
| role | Role | ◯ | ロール（デフォルト: user） |
| avatar | Image | | アバター画像 |
| headerImage | Image | | プロフィールのヘッダー画像 |
| bio | String | | 自己紹介文（200文字以内） |
| userPrompt | String | | 台本生成の基本方針（全チャンネル・エピソードに適用、内部管理用） |

#### userPrompt の適用

台本生成時、プロンプトは以下の順序で結合（追記）される：

1. **User.userPrompt** - ユーザーの基本方針
2. **Channel.userPrompt** - チャンネル固有の方針

#### username の自動生成

- 新規登録時、`displayName` から自動生成される
- スペースはアンダースコアに変換
- 重複時はランダムな番号をサフィックスとして付与
- 後からアカウント設定画面で変更可能

### Credential（パスワード認証）

メール/パスワード認証用の認証情報。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所属する User |
| passwordHash | String | ◯ | パスワードハッシュ（bcrypt） |

#### 制約

- User と 1:1 の関係（1 ユーザーにつき 1 つ）
- OAuth のみで登録したユーザーは Credential を持たない

### OAuthAccount（OAuth 認証）

OAuth プロバイダとの連携情報。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所属する User |
| provider | OAuthProvider | ◯ | プロバイダ（google） |
| providerUserId | String | ◯ | プロバイダ側のユーザー ID |
| accessToken | String | | アクセストークン |
| refreshToken | String | | リフレッシュトークン |
| expiresAt | DateTime | | トークン有効期限 |

#### 制約

- User と 1:N の関係（複数プロバイダ連携可能）
- provider + providerUserId の組み合わせは一意

### RefreshToken（リフレッシュトークン）

アクセストークンを再発行するためのリフレッシュトークン。DB に保存してサーバー側で無効化を管理する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所属する User |
| token | String | ◯ | トークン文字列（ランダム生成、一意） |
| expiresAt | DateTime | ◯ | 有効期限 |

#### 制約

- User と 1:N の関係（複数デバイスからの同時ログインに対応）
- token は一意
- トークンリフレッシュ時はトークンローテーションを行う（旧トークンを削除し、新しいトークンを発行）
- ログアウト時にトークンを削除して無効化
- 有効期限: 30日

### ApiKey（API キー）

JWT Bearer トークンの代替認証手段。セキュリティ上、平文は作成時に 1 度だけ表示し、DB には SHA-256 ハッシュのみ保存する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所属する User |
| name | String | ◯ | 管理名（100文字以内） |
| keyHash | String | ◯ | API Key の SHA-256 ハッシュ |
| prefix | String | ◯ | 表示用プレフィックス（例: ak_a1b2c3...） |
| lastUsedAt | DateTime | | 最終使用日時 |

#### 制約

- User と 1:N の関係（複数の API Key を所持可能）
- 同一 User 内で name は一意
- keyHash は全体で一意
- 認証方式: `X-API-Key` ヘッダーまたは `Authorization: Bearer ak_...` をサポート
- 平文キーは `ak_` プレフィックス + 32 バイトのランダム hex 文字列

### Character（キャラクター）

チャンネルに登場させるキャラクター。ユーザーが作成・管理し、複数のチャンネルで使い回すことができる。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所有する User |
| name | String | ◯ | キャラクター名 |
| persona | String | | キャラクター設定（性格・話し方など） |
| avatar | Image | | アバター画像 |
| voice | Voice | ◯ | TTS ボイス |

#### 制約

- **名前の一意性**: 同一 User 内で重複禁止
- **ボイス選択**: is_active = true の Voice のみ選択可能
- **削除制限**: いずれかの Channel で使用中のキャラクターは削除不可

---

## Channel 集約

### Channel（チャンネル）

ポッドキャストのチャンネル。複数のエピソードを管理し、User が所有するキャラクターを紐づける。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | オーナー |
| name | String | ◯ | チャンネル名 |
| description | String | | チャンネルの概要・説明（公開情報） |
| userPrompt | String | | 台本生成の全体方針（AI への指示、内部管理用） |
| category | Category | ◯ | カテゴリ |
| artwork | Image | | カバー画像（ポッドキャストのアートワーク） |
| characters | Character[] | ◯ | 登場人物（1〜2 人、User が所有するキャラクターへの参照） |
| defaultBgm | Bgm | | デフォルト BGM（ユーザー所有） |
| defaultSystemBgm | SystemBgm | | デフォルト BGM（システム提供） |
| publishedAt | DateTime | | 公開日時（NULL = 下書き） |

#### 不変条件

- characters は 1〜2 人（最小 1 人、最大 2 人）
- characters は同一 User が所有するキャラクターのみ紐づけ可能
- characters は全員同一のボイスプロバイダー（Voice.provider）を使用すること
- defaultBgm と defaultSystemBgm は同時に設定不可（排他的）
- 公開中のチャンネルは削除不可（先に非公開化が必要、将来的に検討）

---

## Episode 集約

### Episode（エピソード）

チャンネル内の各エピソード。台本と BGM を持つ。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| channelId | UUID | ◯ | 所属する Channel |
| title | String | ◯ | エピソードタイトル |
| description | String | | エピソードの説明（公開情報） |
| script | ScriptLine[] | | 台本（順序付きの ScriptLine 配列） |
| bgm | Audio | | BGM 音声ファイル |
| voiceAudio | Audio | | ボイス単体の音声（BGM なし） |
| fullAudio | Audio | | 結合済み音声（全 ScriptLine + BGM） |
| playCount | Int | ◯ | 再生回数（デフォルト: 0） |
| publishedAt | DateTime | | 公開日時（NULL = 下書き） |

#### playCount の更新ルール

- 再生開始から 30 秒経過した時点でクライアントが API を呼び出し、`play_count` を +1 する
- 同一ユーザーが同じエピソードを複数回再生した場合も毎回カウントする
- 公開中（`publishedAt <= NOW()`）のエピソードのみカウント対象

#### 入力形式

エピソード作成時の入力は以下のいずれか：

| 入力形式 | 説明 |
|----------|------|
| テキスト入力 | テーマやシナリオを入力して LLM が台本生成。URL が含まれていれば RAG で内容を取得 |
| ファイル入力 | 台本フォーマットのファイルをインポート |
| 音声ファイルアップロード | 録音・編集済みの音声ファイルを直接アップロード（voiceAudio / fullAudio に同一ファイルを設定） |

#### BGM

- BGM は音声生成時に指定する（`type=full` / `type=remix`）
- 最後に使用した BGM をエピソードに記録（次回生成時の復元表示用）
- 音声ファイル形式: mp3

### ScriptLine（台本行）

台本の各行（セリフ）。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子（= lineId）。並び替え・編集後も追跡可能 |
| episodeId | UUID | ◯ | 所属する Episode |
| lineOrder | Int | ◯ | 行の順序（0 始まり） |
| speaker | Character | ◯ | 話者 |
| text | String | ◯ | セリフ（空禁止） |
| emotion | String | | 感情・喋り方。例: excited, laughing, curious |

#### emotion の反映

emotion は TTS 生成時に text の先頭にカッコで付けて表現する：

```
[laughing] こんにちは。
[empathetic] さようなら...
```

#### 制約

- speaker は同じ Channel に属する Character のみ指定可能
- lineOrder は Episode 内で一意

### 台本の編集操作

- 行の追加
- 行の全削除（エピソード内の全行を削除）
- 行の削除
- 行の並び替え
- 行の更新

---

## 台本テキストフォーマット

台本の取り込み・出力時に使用するテキスト形式。

### 基本ルール

- 区切りは半角 `:` のみ
- 1 行 = 1 セリフ
- 複数行のセリフは同キャラを連続して記述

### 構文

```
<speakerName>: <text>
```

### 例

```
太郎: こんにちは
花子: やあ、元気？
太郎: うん、元気だよ
花子: それは良かった
```

---

## 取り込みバリデーション

### 入力

- 台本テキスト
- allowedSpeakers（Channel の登場人物名リスト）

### 出力

- 成功: ScriptLine 配列
- 失敗: エラー（行番号 + 理由）

### バリデーションルール

| 条件 | 結果 |
|------|------|
| `:` が無い行 | エラー |
| lhs / rhs を trim 後に処理 | - |
| lhs が allowedSpeakers に存在しない | エラー |
| rhs（セリフ）が空 | エラー |

---

## 音声生成

エピソード単位で完成形の音声を生成する。TTS API の制約により、行単位ではなくエピソード全体を一括で生成する。

### ユースケース

音声生成は統合エンドポイント（`generate-async`）の `type` パラメータで 3 種類を切り替える。

| type | 説明 | TTS | BGM |
|------|------|:---:|:---:|
| `voice` | ボイス音声のみ生成（BGM なし） | ◯ | - |
| `full` | TTS 音声生成 + BGM ミキシング | ◯ | ◯ |
| `remix` | 既存ボイス音声を再利用して BGM のみ差し替え | - | ◯ |

### 生成フロー（type=voice / type=full）

1. 台本の全行を取得
2. 各行のテキストを結合（emotion は `[感情]` 形式で先頭に付与）
3. TTS API で音声を一括生成
4. ボイス音声を `Episode.voiceAudio` に保存
5. `type=full` の場合、リクエストで指定された BGM とミックス
6. 結果を `Episode.fullAudio` に保存
7. `type=full` / `type=remix` の場合、`Episode.bgmId` / `systemBgmId` を更新

### 生成フロー（type=remix）

1. `Episode.voiceAudio` が存在することを確認
2. GCS から `voiceAudio` をダウンロード
3. リクエストで指定された BGM とミキシング
4. 結果を `Episode.fullAudio` に保存
5. `Episode.bgmId` / `systemBgmId` を更新

### 出力形式

- 形式: mp3
- 保存先: `Episode.fullAudio`

### 再生成

- 台本を編集した場合は音声の再生成が必要
- 再生成時は既存の `fullAudio` を削除して新規生成

---

## Playlist 集約

### Playlist（再生リスト）

ユーザーが所有する再生リスト。エピソードを順序付きで管理する。YouTube の再生リストに相当。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | 所有する User |
| name | String | ◯ | 再生リスト名（100文字以内） |
| description | String | | 説明（500文字以内） |
| isDefault | Boolean | ◯ | デフォルト再生リストフラグ |
| createdAt | DateTime | ◯ | 作成日時 |
| updatedAt | DateTime | ◯ | 更新日時 |

#### 制約

- **名前の一意性**: 同一 User 内で重複禁止
- **デフォルト再生リスト**: 各ユーザーにつき 1 つのみ。名前は「後で聴く」固定
- **デフォルト再生リストの制限**: 削除・名前変更不可。説明のみ編集可能
- **自動作成**: ユーザー登録時にデフォルト再生リスト「後で聴く」が自動作成される

### PlaylistItem（再生リストアイテム）

再生リスト内のエピソード。順序を持つ。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| playlistId | UUID | ◯ | 所属する Playlist |
| episodeId | UUID | ◯ | 追加された Episode |
| position | Int | ◯ | 再生リスト内の順序（0始まり） |
| addedAt | DateTime | ◯ | 追加日時 |

#### 制約

- **重複禁止**: 同一再生リスト内で同じエピソードは 1 回のみ
- **順序の一意性**: 同一再生リスト内で position は一意

---

## ユーザーインタラクション

ユーザーとエピソードの関係を表すエンティティ群。

### Reaction（リアクション）

ユーザーがエピソードに対して行ったリアクション（like / bad）を記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | ユーザー |
| episodeId | UUID | ◯ | エピソード |
| reactionType | ReactionType | ◯ | リアクションタイプ（like / bad） |
| createdAt | DateTime | ◯ | リアクション登録日時 |

#### 制約

- user + episode の組み合わせは一意（同じエピソードには 1 つのリアクションのみ）
- 公開されているエピソードのみリアクションできる
- like は「高評価」として一覧表示に使用される

### Follow（フォロー）

ユーザーが他のユーザーをフォローしたことを記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | フォローしたユーザー |
| targetUserId | UUID | ◯ | フォロー対象のユーザー |
| createdAt | DateTime | ◯ | フォロー登録日時 |

#### 制約

- user + targetUser の組み合わせは一意（同じユーザーを複数回フォローできない）
- 自分自身はフォローできない

#### ユースケース

- **新着通知**: フォローしたユーザーの新エピソード通知（将来対応）
- **フォローリスト**: フォロー中のユーザー一覧表示

### PlaybackHistory（再生履歴）

ユーザーのエピソード再生履歴と再生位置を記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | ユーザー |
| episodeId | UUID | ◯ | エピソード |
| progressMs | Int | ◯ | 再生位置（ミリ秒）、デフォルト 0 |
| completed | Boolean | ◯ | 再生完了フラグ、デフォルト false |
| playedAt | DateTime | ◯ | 最終再生日時 |

#### 制約

- user + episode の組み合わせは一意（履歴は上書き更新される）
- progressMs は 0 以上

#### ユースケース

- **レジューム再生**: 途中から再生を再開
- **視聴完了トラッキング**: 最後まで聴いたエピソードの管理
- **視聴履歴表示**: 最近聴いたエピソードの一覧

### Comment（コメント）

ユーザーがエピソードに対して投稿したコメントを記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | コメント投稿者 |
| episodeId | UUID | ◯ | 対象エピソード |
| content | String | ◯ | コメント本文（1〜1000文字） |
| deletedAt | DateTime | | 削除日時（NULL = 有効） |
| createdAt | DateTime | ◯ | 投稿日時 |
| updatedAt | DateTime | ◯ | 更新日時 |

#### 制約

- 公開されているエピソードのみコメント可能
- コメント編集・削除は投稿者本人または Admin のみ
- 削除されたコメントは一覧に表示されない（論理削除）

### FavoriteVoice（ボイスお気に入り）

ユーザーがボイスをお気に入り登録したことを記録する。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | ◯ | ユーザー |
| voiceId | UUID | ◯ | お気に入りのボイス |
| createdAt | DateTime | ◯ | 登録日時 |

#### 制約

- user + voice の組み合わせは一意（同じボイスを複数回お気に入り登録できない）

---

## マスタデータ

システムが管理するマスタデータ。ユーザーは参照のみ可能。

### Voice（ボイス）

TTS ボイスの設定情報。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| provider | String | ◯ | TTS プロバイダ（google / azure / etc） |
| providerVoiceId | String | ◯ | プロバイダ側の音声 ID（例: ja-JP-Wavenet-C） |
| name | String | ◯ | 表示名 |
| gender | Gender | ◯ | 性別（male / female / neutral） |
| sampleAudioUrl | String | ◯ | サンプルボイス音声の URL |
| isActive | Boolean | ◯ | 有効フラグ |

#### 制約

- provider + providerVoiceId の組み合わせは一意
- isActive = false の Voice は新規キャラクター作成時に選択不可
- 既存キャラクターは isActive = false の Voice を継続利用可能
- 物理削除は行わず、isActive フラグで無効化

#### TTS プロバイダ

| プロバイダ | 説明 |
|------------|------|
| google | Google Cloud Text-to-Speech |
| azure | Azure Cognitive Services（将来対応） |

### Category（カテゴリ）

ポッドキャストのカテゴリ。Apple Podcasts 準拠。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| slug | String | ◯ | URL フレンドリーな識別子（例: technology） |
| name | String | ◯ | 表示名（例: テクノロジー） |
| image | Image | | カテゴリ画像 |
| sortOrder | Int | ◯ | 表示順 |
| isActive | Boolean | ◯ | 有効フラグ |

#### 制約

- slug は一意
- isActive = false のカテゴリは新規チャンネル作成時に選択不可
- 既存チャンネルは isActive = false のカテゴリを継続利用可能
- 物理削除は行わず、isActive フラグで無効化

---

## メディア

外部ストレージに保存されるメディアファイル。

### Audio（音声ファイル）

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| mimeType | String | ◯ | MIME タイプ（audio/mpeg など） |
| path | String | ◯ | GCS 上のパス（例: audios/xxx.mp3） |
| filename | String | ◯ | 元ファイル名 |
| fileSize | Int | ◯ | ファイルサイズ（バイト） |
| durationMs | Int | ◯ | 再生時間（ミリ秒） |

#### 用途

| 用途 | 説明 |
|------|------|
| BGM | エピソードの背景音楽 |
| エピソード全体音声 | 全台本 + BGM を結合した完成形音声 |

#### 制約

- ファイルサイズは 50MB 以下
- 再生時間は 60分以下

### Image（画像ファイル）

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| mimeType | String | ◯ | MIME タイプ（image/png, image/jpeg など） |
| url | String | ◯ | ストレージ URL（GCS） |
| filename | String | ◯ | 元ファイル名 |
| fileSize | Int | ◯ | ファイルサイズ（バイト） |

#### 用途

| 用途 | 説明 |
|------|------|
| アバター | ユーザー / キャラクターのプロフィール画像 |
| ヘッダー画像 | ユーザーのプロフィールヘッダー画像 |
| アートワーク | チャンネル / エピソードのカバー画像 |

#### 制約

- ファイルサイズは 10MB 以下

### メディア管理

- Audio.path / Image.path には GCS（Google Cloud Storage）上のパスを保存（例: `audios/xxx.mp3`, `images/xxx.png`）
- Image.path には外部 URL（`http://` / `https://` で始まるもの）も格納可能
- API レスポンス時に署名付き URL を動的生成してクライアントに返す
  - 外部 URL の場合は署名付き URL の生成をスキップし、パスをそのまま URL として返す
- 同一ファイルを複数箇所から参照可能（BGM の使い回しなど）
- 参照元が削除されてもメディアファイルは残る（SET NULL）
- 未使用ファイルのクリーンアップはバッチ処理で実施
  - 外部 URL の画像は GCS 削除をスキップし、DB レコードのみ削除

---

## サポート

### Contact（お問い合わせ）

ユーザーからのお問い合わせ。認証任意で、未ログインユーザーからも受け付け可能。

| 属性 | 型 | 必須 | 説明 |
|------|-----|:----:|------|
| id | UUID | ◯ | 識別子 |
| userId | UUID | | 送信ユーザー（ログイン済みの場合のみ） |
| category | ContactCategory | ◯ | カテゴリ |
| email | Email | ◯ | メールアドレス |
| name | String | ◯ | 名前（100文字以内） |
| content | String | ◯ | お問い合わせ内容（1〜5000文字） |
| userAgent | String | | ブラウザの User-Agent |
| createdAt | DateTime | ◯ | 作成日時 |

#### 制約

- 認証任意: ログイン済みの場合は `userId` が自動的にセットされる
- `userId` が設定されている場合、ユーザー削除時に SET NULL（お問い合わせ自体は残る）
- content は 1〜5000 文字
